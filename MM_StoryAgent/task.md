# 将现有Python应用重构为后端服务

## 核心需求

1. 使用**django + ninja**架构，搭建**python**后端。

2. 使用**multi-agent + workflow**流程，使用户可以安全、稳定、高效地使用提供的服务。

3. 理解现有代码框架和功能，在不影响基础使用功能的要求上进行重构。

   

## 概念理解

### Multi-Agent + Workflow

1. 本项目使用多个**Agent**，每个Agent负责工作流中的一个或多个**环节**。
2. 大体上来说，工作流由串行的几个**环节（segment）**组成：用户输入主题 -> 主题生成文本（StoryAgent） -> 文本生成图片（ImageAgent）-> 文本切分生成字幕（SplitAgent）-> 字幕生成语音（SpeechAgent）-> 最终合成视频（VideoAgent）
3. 从用户来看，一个**任务（task）**应该是**线性但可重复的**，这意味着用户只能按照拓扑顺序依次执行任务环节，但是可以随时对先前的环节进行修改，但是一旦修改，就只能从该修改环节向后依次执行。



## 接口概览

### 用户相关

1. `POST /api/login` 用户使用用户名和密码进行登录，如若登录信息正确，则按照HTTP安全标准返回`Bearer Token`（存放于Header - Authorization，用于验证身份）和`Refresh Token`（存放于Cookie，用于刷新Bearer Token）。
2. `POST /api/register` 用户使用用户名和密码注册。注意用户名不可重复。返回注册信息。
3. `POST /api/refresh` 浏览器通过`Refresh Token`刷新`Bearer Token`。返回新发放的Bearer Token。

### 任务执行相关

1. `GET /api/task/workflow` 查询目前服务器端配置的工作流环节。后端应当返回一个有序列表，元素为字典，其含有"id"和"name"两个键，分别对应工作流的拓扑顺序编号和名称，列表按照工作流的拓扑顺序升序排列。

2. `POST /api/task/new` 创建一个新任务。该请求需要包含用户输入的故事主题，返回该任务的对应id。
3. `GET /api/task/{id}/progress` 查询id对应任务的进度信息。后端应当将工作流环节按照拓扑顺序由小到大编号，该接口返回已经完成的最大环节号。
4. `GET /api/task/mytasks` 返回token对应用户的现有任务，无论是正在进行的还是已完成的。返回一个task_id列表。
5. `GET /api/task/{id}/resource` 该请求除了包含任务id（路径变量）以外，还应该带有一个segmentId（请求变量）用于标志获取哪个环节的资源。若该环节已经完成，则返回该环节的执行结果（如文本、语音、图片），否则返回错误信息。
6. `POST /api/task/{id}/execute/{segmentId}` 该请求应当执行id对应任务的第segmentId环节。若该环节不该被执行，返回错误信息；否则执行该环节，执行后应当通过一定手段（消息队列）告诉用户该环节执行完毕，并更新当前任务的进度信息。
7. `DELETE /api/task/{id}` 该请求会删除对应任务及其在服务器上的所有已生成资源。



## 中间件选择

1. 数据库：使用sqlite3作为本地原型开发的第一选择。
2. 消息队列：选择适用于windows环境、适配本项目的最佳选择。



## 服务器端配置

配置文件应当遵守高内聚、低耦合、模块化的设计要求，能够灵活地进行配置。支持热更新。



## 其他

数据库Schema和请求参数允许自主设计，遵守简单、易用、易扩展的原则。

